{% set title = _('Search') %}

<script>
    Vue.component("Searchme", {
        data() {
            return {
                test: 'test1',
                recipes: [],
                headers: [
                    {
                        text: 'Identifier',
                        value: 'identifier',
                        align: 'left',
                        sortable: true,
                    },
                    {
                        text: 'Recipe Name',
                        value: 'name',
                        align: 'left',
                        sortable: true,
                    },
                    {
                        text: 'Recipe Type',
                        value: 'type',
                        align: 'left',
                        sortable: true,
                    },
                    {
                        text: 'Reading Time',
                        value: 'reading_time',
                        align: 'left',
                        sortable: true,
                    },
                    {
                        text: 'Executable Code',
                        value: 'executable',
                        align: 'left',
                        sortable: true,
                    },
                    {
                        text: 'Audience',
                        value: 'audience',
                        align: 'left',
                        sortable: true,
                    },
                    {
                        text: 'Maturity Level',
                        value: 'maturity',
                        align: 'left',
                        sortable: true,
                    }
                ],
                all_recipes: [],
                loading: false,
                inputs: {
                    name: null,
                    recipeType: {
                        values: [],
                        value: null
                    },
                    audience: {
                        values: [],
                        value: null
                    },
                    readingTime: {
                        min: 0,
                        max: 60,
                        range: [0, 60],
                        labels: [
                            "0 min", null,
                            "10 min", null,
                            "20 min", null,
                            "30 min", null,
                            "40 min", null,
                            "50 min", null,
                            "60 min"
                        ]
                    },
                    executable: {
                        value: 0,
                        labels: ["Both", "Yes", "No"]
                    },
                    maturity: 0
                }
            }
        },
        methods: {
            async getData(){
                this.loading = true
                const response = await fetch('/_static/recipes.json');
                const data = await response.json();
                this.loading = false
                this.recipes = Object.entries(data).map((key, value) => {
                    const recipe = key[1]

                    // Add autocomplete values for recipe types
                    if (!this.inputs.recipeType.values.includes(recipe.type)) {
                        this.inputs.recipeType.values.push(recipe.type)
                    }

                    // Add autocomplete values for audience
                    recipe.audience.forEach(audience => {
                        if (!this.inputs.audience.values.includes(audience)) {
                            this.inputs.audience.values.push(audience)
                        }
                    })

                    return recipe

                })
                this.all_recipes = [ ...this.recipes ]
            },
            filterRecipes() {
                let recipes = []
                this.all_recipes.forEach(recipe => {
                    const name = this.hasName(recipe)
                    const type = this.hasType(recipe)
                    const readingTime = this.inReadingTime(recipe)
                    const audience = this.hasAudience(recipe)
                    const executable = this.isExecutable(recipe)
                    const maturity = this.hasMaturity(recipe)
                    if (name && type && readingTime && audience && executable && maturity) { recipes.push(recipe) }
                })
                this.recipes = recipes
            },
            hasName(recipe){
                if (!this.inputs.name) { return true }
                return recipe.name.toLowerCase().includes(this.inputs.name.toLowerCase())
            },
            hasType(recipe){
                if (!this.inputs.recipeType.value) { return true }
                return recipe.type.toLowerCase().includes(this.inputs.recipeType.value.toLowerCase())
            },
            inReadingTime(recipe) {
                if (this.inputs.readingTime.range[0] === 0 && this.inputs.readingTime.range[1] === 0) { return true }
                const readingTime = recipe.reading_time
                return readingTime >= this.inputs.readingTime.range[0] && readingTime <= this.inputs.readingTime.range[1]
            },
            hasAudience(recipe){
                if (!this.inputs.audience.value) { return true }
                return recipe.audience.includes(this.inputs.audience.value)
            },
            isExecutable(recipe) {
                const mapping = {
                    1: "Yes",
                    2: "No"
                }
                if (this.inputs.executable.value === 0) { return true }
                else {
                    const value = mapping[this.inputs.executable.value]
                    return recipe.executable.toLowerCase() === value.toLowerCase()
                }
            },
            getColor(recipe) {
               if (recipe.executable === "Yes") { return "primary" }
               return "secondary"
            },
            resetFilters() {
                this.recipes = [ ...this.all_recipes ]
                this.inputs.name = null
                this.inputs.recipeType.value = null
                this.inputs.audience.value = null
                this.inputs.readingTime.value = [0, 60]
                this.inputs.executable.value = 0
                this.inputs.maturity = 0
            },
            hasMaturity(recipe) {
                if (this.inputs.maturity === 0) { return true }
                return recipe.maturity >= this.inputs.maturity
            }
        },
        mounted() { this.getData(); },
        template: `
            <div class="search-wizard" id="search-wizard">
                <h1 class="mb-5"> Search the cookbook recipes </h1>
                <v-container fluid>
                    <v-row>
                        <v-col cols="12">
                            <v-card>
                                <v-card-text>
                                    <v-form id="searchRecipesFilters" ref="searchRecipesFilters">
                                        <v-container fluid>
                                            <v-row>
                                                <v-col xl="4" lg="4" md="4" sm="12" xs="12" cols="12">
                                                    <v-text-field
                                                        outlined
                                                        v-model="inputs.name"
                                                        label="Search recipes names"
                                                        @input="filterRecipes"
                                                        hide-details
                                                        dense
                                                    > </v-text-field>
                                                </v-col>
                                                <v-col xl="4" lg="4" md="4" sm="12" xs="12" cols="12">
                                                    <v-autocomplete
                                                        :items="inputs.recipeType.values"
                                                        v-model="inputs.recipeType.value"
                                                        label="Search recipes by type"
                                                        outlined
                                                        @input="filterRecipes"
                                                        hide-details
                                                        dense
                                                    > </v-autocomplete>
                                                </v-col>
                                                <v-col xl="4" lg="4" md="4" sm="12" xs="12" cols="12">
                                                    <v-autocomplete
                                                        :items="inputs.audience.values"
                                                        v-model="inputs.audience.value"
                                                        label="Search recipes by audience"
                                                        outlined
                                                        @input="filterRecipes"
                                                        hide-details
                                                        dense
                                                    > </v-autocomplete>
                                                </v-col>
                                                <v-col xl="6" lg="8" md="12" sm="12" xs="12" cols="12" id="readingTime">
                                                    <div
                                                        class="pa-4 pt-1"
                                                        style="border: 1px solid rgba(0, 0, 0, 0.4); border-radius:5px"
                                                    >
                                                        <span class="field-name">Search recipes by reading time</span>
                                                        <v-range-slider
                                                            v-model="inputs.readingTime.range"
                                                            :max="inputs.readingTime.max"
                                                            :min="inputs.readingTime.min"
                                                            :tick-labels="inputs.readingTime.labels"
                                                            ticks="always"
                                                            tick-size="4"
                                                            step="5"
                                                            class="align-center"
                                                            color="primary"
                                                            track-color="secondary"
                                                            thumb-color="primary"
                                                            @input="filterRecipes"
                                                            hide-details
                                                        ></v-range-slider>
                                                    </div>
                                                </v-col>
                                                <v-col xl="2" lg="4" md="12" sm="12" xs="12" cols="12">
                                                    <div class="pa-4 pt-1" style="border: 1px solid rgba(0, 0, 0, 0.4); border-radius:5px">
                                                        <span class="field-name">Contains executable code</span>
                                                        <v-slider
                                                            v-model="inputs.executable.value"
                                                            min="0"
                                                            max="2"
                                                            step="1"
                                                            ticks="always"
                                                            tick-size="4"
                                                            :tick-labels="inputs.executable.labels"
                                                            color="secondary"
                                                            track-color="secondary"
                                                            thumb-color="primary"
                                                            @input="filterRecipes"
                                                            hide-details
                                                        > </v-slider>
                                                    </div>
                                                </v-col>
                                                <v-col xl="3" lg="4" md="6" sm="12" xs="12" cols="12">
                                                    <div class="pa-4 pt-1" style="border: 1px solid rgba(0, 0, 0, 0.4); border-radius:5px; padding-bottom: 8px !important">
                                                        <span class="field-name">Search by maturity level</span>
                                                        <v-rating
                                                            v-model="inputs.maturity"
                                                            background-color="grey lighten-1"
                                                            color="primary"
                                                            empty-icon="far fa-circle"
                                                            full-icon="fas fa-circle"
                                                            @input="filterRecipes"
                                                        ></v-rating>
                                                    </div>
                                                </v-col>
                                                <v-col xl="1" lg="2" md="6" sm="12" xs="12" cols="12" class="d-flex justify-end align-end">
                                                    <v-btn color="secondary" @click="resetFilters()">
                                                        Reset
                                                    </v-btn>
                                                </v-col>
                                            </v-row>
                                        </v-container>
                                    </v-form>
                                </v-card-text>
                            </v-card>
                        </v-col>
                        <v-col cols="12">
                            <v-card>
                                <v-data-table
                                    class="searchRecipesResults"
                                    fixed-header
                                    height="68vh"
                                    :items="recipes"
                                    :items-per-page="-1"
                                    :headers="headers"
                                    :mobile-breakpoint="900"
                                    hide-default-footer
                                >
                                    <template v-slot:item.identifier="{ item }">
                                        <v-chip color="grey lighten-2" label>
                                            <v-icon small left> fas fa-fingerprint </v-icon> {{ '{{ item.identifier }}' }}
                                        </v-chip>
                                    </template>
                                    <template v-slot:item.name="{ item }">
                                        <a :href="item.url" class="body-2 font-weight-bolder" > {{ '{{ item.name }}' }} </a>
                                    </template>
                                    <template v-slot:item.executable="{ item }">
                                        <v-chip class="white--text" :color="getColor(item)"> {{ '{{ item.executable }}' }} </v-chip>
                                    </template>
                                    <template v-slot:item.audience="{ item }">
                                        {{ '{{ item.audience.join(", ") }}' }}
                                    </template>
                                    <template v-slot:item.reading_time="{ item }">
                                        ~{{ '{{ item.reading_time }}' }} min
                                    </template>
                                    <template v-slot:item.maturity="{ item }">
                                        <v-rating
                                            v-model="item.maturity"
                                            readonly
                                            background-color="grey lighten-1"
                                            color="primary"
                                            empty-icon="far fa-circle"
                                            full-icon="fas fa-circle"
                                            dense
                                            small
                                        ></v-rating>
                                    </template>
                                </v-data-table>
                            </v-card>
                        </v-col>
                    </v-row>
                </v-container>
            </div>
        `
    })
</script>

{% block body %}
    <Searchme> </Searchme>
{% endblock %}